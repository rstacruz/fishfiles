#!/usr/bin/env bash
# Commits, pulls and pushes in one go.
set -eou pipefail

# global options
interactive=''
dry_run=''
use_amend=''
no_commit=''

main() {
  while true; do
    case "${1:-}" in
      -p | --prompt | -i | --interactive)
        interactive='1'
        shift 1
        ;;
      -n | --dry-run)
        dry_run='1'
        shift 1
        ;;
      *) break ;;
    esac
  done

  commit_if_dirty
  if [[ "$use_amend" == '1' ]]; then
    push_updates '1'
  else
    pull_changes
    push_updates
  fi
}

commit_if_dirty() {
  local message=''
  local input=''
  local verbose=''

  if [[ "$(git status -s | wc -l | xargs)" == "0" ]]; then
    no_commit='1'
    return
  fi

  # Show status
  echo "Local changes in $(pwd):"
  echo ''
  git status -s
  echo ''

  if [[ "$interactive" == '1' ]]; then
    while true; do
      echo -ne "\033[2K\r"
      if [[ "$verbose" == "" ]]; then
        echo -n '   [Enter] sync now · [?] more options: '
      else
        echo -e 'Options:'
        echo '  [enter] sync now'
        echo '  [m] change message'
        echo '  [a] amend'
        echo '  [d] show diff'
        echo '  [q] quit'
        echo -n '> '
      fi
      read -n1 input

      case "$input" in
        'c' | '') # Continue
          break ;;
        d) # Diff
          verbose='1'
          clear
          git diff HEAD
          echo '' ;;
        q) # Quit
          exit 1 ;;
        a) # Amend
          use_amend='1'
          break ;;
        '?') # Show options
          verbose='1' ;;
        m) # Commit message
          echo ''
          echo ''
          echo -n 'Commit msg: '
          read -r message
          break ;;
        *) ;;
      esac
    done
    echo ''
  fi

  _git add --all .
  if [[ -z "$message" ]]; then
    message="$(get_default_message || echo 'Update')"
  fi

  if [[ "$use_amend" == '1' ]]; then
    prog_info "Amend commit: ‘${message}’"
    _git commit --amend -C HEAD
  else
    prog_info "Commit: ‘${message}’"
    _git commit -m "$message"
  fi
}

get_default_message() {
  local message=''
  local count=''
  message="$(git status -s | head -n 1 | xargs)"
  count="$(git status -s | wc -l | xargs)"
  message="$(
    echo "$message" |
      sed 's/^M /Update /' |
      sed 's/^R /Remove /' |
      sed 's/^A /Add /'
  )"

  if [[ -z "$message" ]]; then return 1; fi

  # append count
  if [[ "$count" != '1' ]]; then
    message="$message (+$((count - 1)) more changes)"
  fi

  echo "$message"
}

pull_changes() {
  # Pull changes
  if [[ "$no_commit" == '1' ]]; then
    prog_start "Updating $(pwd)"
  else
    prog_start "Pulling changes"
  fi

  if ! _git pull --quiet --rebase --autostash; then
    prog_err "Failed to pull"
    _git rebase --abort
    exit 1
  fi

  prog_ok ''
}

push_updates() {
  # Push if there are any changes
  local message=''
  local force="${1:-}"

  if [[ "$dry_run" == '1' ]] || git status --branch -s | head -n 1 | grep -q ahead; then
    if [[ "$force" == '1' ]]; then
      prog_start 'Force-pushing'
      _git push --quiet --no-progress --force-with-lease
      message="$(git log -1 --pretty='format:%s')"
      prog_ok ''
    else
      prog_start 'Pushing'
      _git push --quiet --no-progress
      message="$(git log -1 --pretty='format:%s')"
      prog_ok ''
    fi
  else
    prog_info "Up to date"
  fi
}

_git() {
  if [[ "$dry_run" == '1' ]]; then
    echo -e "\033[32m$ git $*\033[0m"
  else
    git "$@" >/dev/null
  fi
}

# Progress indicator helpers
check="\033[33m✓"
arrow="\033[32m››"
cross="\033[31m✗"
reset="\033[0m"
rewind="\033[4D\033[K "
prog_start() { echo -ne "${arrow}${reset} $*... "; }
prog_ok() { echo -e "${rewind}${check} $*${reset}"; }
prog_err() { echo -e "${rewind}${cross} $*${reset}"; }
prog_info() { prog_start "$*"; prog_ok; }

main "$@"
